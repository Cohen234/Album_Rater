<!DOCTYPE html>
<html>
<head>
  <title>Albums by {{ artist_name }}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      animation: bgfade 15s infinite alternate;
      background: linear-gradient(-45deg, #ffecd2, #fcb69f, #a1c4fd, #c2e9fb);
      background-size: 400% 400%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    @keyframes bgfade {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    h1 { text-align: center; margin: 20px 0; color: #333; }
    .album-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
      padding: 20px 40px;
    }
    .album-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
      cursor: pointer; /* Make it look clickable */
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .album-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .album-card img {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 12px;
        pointer-events: none; /* Make sure clicking the image still triggers the card click */
    }
    .album-name {
        font-weight: bold;
        font-size: 1em;
        color: #222;
        min-height: 2.5em;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        pointer-events: none;
    }
    .album-name span.paused-icon { margin-left: 5px; }
    .mastery-stars { font-size: 1.2em; margin-top: 5px; pointer-events: none; }
    .mastery-stars .star { color: #ccc; }
    .mastery-stars .star.filled { color: gold; }
    .stats { font-size: 0.9em; color: #555; margin-top: 8px; line-height: 1.4; pointer-events: none;}

    /* HIDE the original button, as requested */
    .album-card button { display: none; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        text-align: center;
        position: relative;
        box-shadow: 0 5px 25px rgba(0,0,0,0.4);
    }
    .modal-content h3 { margin-top: 0; color: #333; }
    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: #888;
    }
    .edition-list { list-style: none; padding: 0; margin: 0; }
    .edition-list li { margin: 10px 0; }
    .edition-button {
        width: 100%;
        padding: 12px;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid #ddd;
        background-color: #f8f8f8;
        cursor: pointer;
        transition: background-color 0.2s ease;
        text-align: left;
        color: #333;
    }
    .edition-button:hover { background-color: #eee; }
   </style>
</head>
<body>
  <h1>{{ artist_name }}</h1>

  <div class="album-grid">
    {% for base_name, editions in grouped_albums.items() %}
      {% set primary_edition = editions[0] %}
      <div class="album-card" data-editions='{{ editions | tojson | forceescape }}'>
        <img src="{{ primary_edition.image }}" alt="{{ base_name }}">
        <h3 class="album-name" title="{{ base_name }}">
            {{ base_name }}
            {% if editions | selectattr('has_prelim_ranks') | list | length > 0 %}
              <span class="paused-icon" title="Paused">⏸️</span>
            {% endif %}
        </h3>
        <div class="mastery-stars" aria-label="Ranking stars">
            {% set display_stars = primary_edition.times_ranked | default(0) | int %}
            {% for i in range(3) %}
                <span class="star {% if i < display_stars %}filled{% endif %}">★</span>
            {% endfor %}
        </div>
        <div class="stats">
          {% if primary_edition.average_score is not none and (primary_edition.times_ranked | int) > 0 %}
              Avg Score: {{ "%.2f"|format(primary_edition.average_score|float) }}
          {% else %}
              Not yet ranked
          {% endif %}
        </div>

        <form action="{{ url_for('view_album') }}" method="post" class="album-form">
          <input type="hidden" name="album_id">
          <input type="hidden" name="album_name">
          <input type="hidden" name="artist_name" value="{{ artist_name }}">
          <input type="hidden" name="album_cover_url">
          <button type="submit">Select Album</button>
        </form>
      </div>
    {% endfor %}
  </div>

  <div id="edition-modal" class="modal-overlay">
      <div class="modal-content">
          <span class="modal-close" id="modal-close-btn">&times;</span>
          <h3 id="modal-title">Select an Edition</h3>
          <ul id="modal-edition-list" class="edition-list">
              </ul>
      </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('edition-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalEditionList = document.getElementById('modal-edition-list');

    document.querySelectorAll('.album-card').forEach(card => {
        card.addEventListener('click', () => {
            const editions = JSON.parse(card.dataset.editions);
            const form = card.querySelector('.album-form'); // Get the form inside this specific card

            if (editions.length === 1) {
                // If only one version, populate this card's form and submit
                submitFormWithEdition(form, editions[0]);
            } else {
                // If multiple versions, show the modal and pass the form to it
                populateAndShowModal(editions, form);
            }
        });
    });

    function submitFormWithEdition(form, edition) {
        form.querySelector('input[name="album_id"]').value = edition.id;
        form.querySelector('input[name="album_name"]').value = edition.full_name;
        form.querySelector('input[name="album_cover_url"]').value = edition.image;
        form.submit();
    }

    function populateAndShowModal(editions, form) {
        modalEditionList.innerHTML = '';
        editions.forEach(edition => {
            const li = document.createElement('li');
            const button = document.createElement('button');
            button.className = 'edition-button';
            button.textContent = edition.full_name;

            button.addEventListener('click', () => {
                submitFormWithEdition(form, edition);
            });

            li.appendChild(button);
            modalEditionList.appendChild(li);
        });
        modal.style.display = 'flex';
    }

    modalCloseBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
});
</script>
</body>
</html>