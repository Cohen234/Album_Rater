<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ album.album_name }} - {{ album.artist_name }} Ranking</title>
    <style>
        /* Base styles */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header section */
        header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        header img {
            height: 120px;
            width: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        header .album-info h1 {
            margin: 0 0 5px 0;
            font-size: 28px;
            font-weight: bold;
            color: #fff;
        }

        header .album-info h2 {
            margin: 0;
            font-size: 20px;
            font-weight: normal;
            color: #bbb;
        }

        /* Main content container */
        #container {
            display: flex;
            flex: 1; /* Allow container to fill available height */
            gap: 20px;
            padding: 20px;
        }

        /* Left panel: song list */
        #songListContainer {
            flex: 1;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative; /* For scrollbar styling */
        }

        #songListContainer h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        #songList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .song-item {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #333 0%, #444 100%);
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .song-item:hover {
            background: linear-gradient(135deg, #444 0%, #555 100%);
            transform: translateX(4px);
        }

        .song-item.dragging {
            opacity: 0.7;
            transform: rotate(5deg);
        }

        .song-item.ranked {
            border-left-color: #4CAF50; /* Green checkmark indicator */
            cursor: default;
            opacity: 0.7;
            filter: grayscale(20%);
        }
        .song-item.ranked .prelim-rank-input {
            pointer-events: none;
            opacity: 0.7;
            background: #555; /* Darker background for disabled input */
        }

        .song-name {
            flex: 1;
            font-weight: 500;
        }

        .prelim-rank-input {
            width: 60px;
            margin: 0 10px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .prelim-rank-input:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .checkmark {
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-item.ranked .checkmark {
            opacity: 1;
        }

        /* Right panel: ranking interface */
        #rankContainer {
            flex: 1.5;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        #rankContainer h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        #rankButtons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }

        .rank-button {
            padding: 10px 8px;
            background: linear-gradient(135deg, #555 0%, #666 100%);
            color: #ddd;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rank-button:hover {
            background: linear-gradient(135deg, #666 0%, #777 100%);
            transform: translateY(-2px);
        }

        .rank-button.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            font-weight: bold;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        /* Icon for rank buttons indicating content */
        .rank-button-icon {
            margin-left: 5px;
            font-size: 0.8em;
            color: #ccc;
            visibility: hidden;
        }

        .rank-button.has-songs .rank-button-icon {
            visibility: visible;
            color: #000; /* Darker star for active button content indicator */
        }

        .rank-button.has-songs .rank-button-icon::before {
            content: "â˜…";
        }

        /* Main display area for the currently active rank group */
        #activeRankGroupDisplay {
            flex: 1; /* Take remaining space */
            background: rgba(0,0,0,0.6);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            min-height: 200px;
            border: 2px dashed #555; /* Indicates it's a drop zone */
            transition: border-color 0.3s ease, background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #activeRankGroupDisplay.drag-over {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        /* Container for the actual list of songs within the active group */
        #currentRankGroupContent {
            width: 100%;
            display: flex;
            justify-content: center; /* Center the list within its parent */
        }

        #rankedSongsList {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%; /* Take full width of its container */
            min-height: 50px; /* Give it some height for dragging into */
            /* If you want a visual drop indicator border on the list itself */
            /* border: 1px dashed rgba(255,255,255,0.3); */
            /* border-radius: 5px; */
        }

        .empty-state {
            text-align: center;
            color: #888;
            font-style: italic;
            margin: auto; /* Centers itself in the flex container */
            padding: 20px;
            display: block; /* Shown by default until JS hides it or loads songs */
        }

        .ranked-song {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.2s ease;
            color: white;
            font-weight: 500;
            position: relative;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .ranked-song:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .ranked-song.dragging {
            opacity: 0.7;
            transform: rotate(3deg);
        }

        .ranked-song.drag-over { /* For visual insertion point */
            border-top: 2px solid #FFD700;
            margin-top: 20px; /* Create space for the indicator */
        }
        .ranked-song.drag-over:first-child {
            border-top: 2px solid #FFD700;
        }

        .position-indicator {
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            background: #FFD700;
            color: #000;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .score-preview {
            font-size: 12px;
            color: #FFD700;
            margin-left: auto; /* Push to the right */
            font-weight: normal;
        }

        /* Footer buttons */
        #actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
        }

        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #pauseSaveBtn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }

        #pauseSaveBtn:hover {
            background: linear: gradient(135deg, #FFB74D 0%, #FF9800 100%);
            transform: translateY(-2px);
        }

        #finalRankBtn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        #finalRankBtn:hover {
            background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%);
            transform: translateY(-2px);
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <header>
        <img src="{{ album.album_cover_url }}" alt="Album Cover">
        <div class="album-info">
            <h1>{{ album.album_name }}</h1>
            <h2>{{ album.artist_name }}</h2>
        </div>
    </header>

    <form id="rankingForm" method="post" action="/submit_rankings">
        <input type="hidden" name="album_name" value="{{ album.album_name }}">
        <input type="hidden" name="artist_name" value="{{ album.artist_name }}">
        <input type="hidden" id="selected_rank" name="selected_rank" value="">
        <input type="hidden" id="status" name="status" value="">
        <input type="hidden" id="all_ranked_data" name="all_ranked_data" value="">
        <input type="hidden" id="prelim_rank_data" name="prelim_rank_data" value="">


        <div id="container">
            <div id="songListContainer">
                <h3>Songs</h3>
                <ul id="songList">
                    {% for song in album.songs %}
                    <li class="song-item {% if song.get('already_ranked') %}ranked{% endif %}"
                        draggable="true"
                        data-song="{{ song.song_name }}"
                        data-song-id="{{ song.song_id }}">
                        <span class="song-name">{{ song.song_name }}</span>
                        <input type="number"
                               class="prelim-rank-input"
                               min="0.5"
                               max="10"
                               step="0.5"
                               name="prelim_rank_{{ song.song_id }}"
                               value="{{ song.get('prelim_rank', '') }}"
                               placeholder="0.5-10"
                               title="Preliminary rank (0.5-10)">
                        <span class="checkmark">âœ“</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div id="rankContainer">
                <h3>Rank Groups</h3>
                <div id="rankButtons">
                    {% for i in range(1, 21) %}
                        {% set rank = (i * 0.5)|round(1) %}
                        <button type="button" class="rank-button" data-rank="{{ rank }}" id="rank-btn-{{ rank }}">
                            {{ rank }}
                            <span class="rank-button-icon"></span>
                        </button>
                    {% endfor %}
                    <button type="button" class="rank-button" data-rank="?" id="rank-btn-question">
                        ?
                        <span class="rank-button-icon"></span>
                    </button>
                </div>

                <div id="activeRankGroupDisplay">
                    <div class="empty-state" id="emptyState">
                        Select a rank group above to start ranking songs.
                    </div>
                    <div id="currentRankGroupContent">
                        <ul id="rankedSongsList">
                            </ul>
                    </div>
                </div>

                <div id="actions">
                    <button type="button" class="action-button" id="pauseSaveBtn">Pause & Save</button>
                    <button type="button" class="action-button" id="finalRankBtn">Final Rank</button>
                </div>
            </div>
        </div>
    </form>

    <script>
    let draggingSong = null;
    let currentRankGroup = null; // Stores the currently selected rank (e.g., "4.5", "5.0", "?")

    // Global data structure to hold all ranked songs, organized by group
    let allRankedSongsByGroup = {};

    // On page load, initialize allRankedSongsByGroup with data from Flask
    const initialRankGroups = {{ rank_groups | tojson }};
    console.log("Initial rank groups from Flask:", initialRankGroups);

    // Initialize all possible rank groups and populate them from initialRankGroups
    for (let i = 1; i <= 20; i++) {
        const rank = (i * 0.5).toFixed(1);
        allRankedSongsByGroup[rank] = initialRankGroups[rank] || [];
    }
    allRankedSongsByGroup['?'] = initialRankGroups['?'] || []; // Initialize '?' group explicitly

    // Add event listeners to rank buttons
    document.querySelectorAll('.rank-button').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.rank-button').forEach(btn => btn.classList.remove('active'));
            // Add active class to the clicked button
            this.classList.add('active');

            currentRankGroup = this.dataset.rank;
            console.log("Selected rank group:", currentRankGroup);
            loadRankedSongsIntoDisplay(currentRankGroup);
        });
    });

    // Helper to check if a song (by ID) is ranked in *any* group
    function isSongRankedGlobally(songId) {
        for (const group in allRankedSongsByGroup) {
            // Check if the song exists in this group AND it's not the '?' group
            // (songs in '?' are considered "preliminary" and can still be dragged/moved)
            if (group !== '?' && allRankedSongsByGroup[group].some(s => s.song_id === songId)) {
                return true;
            }
        }
        return false;
    }

    // Function to update the icon of a RANK BUTTON based on its group's content
    function updateRankButtonIcon(rankGroupKey) {
        const rankButtonId = rankGroupKey === '?' ? 'rank-btn-question' : `rank-btn-${rankGroupKey}`;
        const rankButton = document.getElementById(rankButtonId);
        if (!rankButton) return;

        const songsInGroup = allRankedSongsByGroup[rankGroupKey] || [];

        if (songsInGroup.length > 0) {
            rankButton.classList.add('has-songs');
        } else {
            rankButton.classList.remove('has-songs');
        }
    }

    // Function to update icons for ALL rank buttons
    function updateAllRankButtonIcons() {
        for (let i = 1; i <= 20; i++) {
            updateRankButtonIcon((i * 0.5).toFixed(1));
        }
        updateRankButtonIcon('?'); // Update the '?' button as well
    }

    // This function now *displays* songs from the global data structure
    function loadRankedSongsIntoDisplay(rank) {
        const rankedSongsListDisplay = document.getElementById('rankedSongsList');
        const emptyState = document.getElementById('emptyState');
        rankedSongsListDisplay.innerHTML = ''; // Clear current display

        const songsToDisplay = allRankedSongsByGroup[rank] || [];
        console.log(`Displaying ${songsToDisplay.length} songs for rank group: ${rank}`);

        if (songsToDisplay.length === 0) {
             emptyState.style.display = 'block'; // Show empty state if no songs
             emptyState.textContent = `Drag songs here to rank them in the ${rank} group.`;
             rankedSongsListDisplay.style.display = 'none'; // Hide the ul if empty
        } else {
             emptyState.style.display = 'none';
             rankedSongsListDisplay.style.display = 'block'; // Show the ul if songs are present
        }

        songsToDisplay.forEach((song, index) => {
            const li = createRankedSongElement(song, index, songsToDisplay.length, rank);
            rankedSongsListDisplay.appendChild(li);
        });

        updateSongCheckmarks(); // Update checkmarks on the left panel
    }

    // Helper to create a ranked song <li> element
    function createRankedSongElement(songData, index, totalSongsInGroup, currentRankGroupKey) {
        const li = document.createElement('li');
        li.className = 'ranked-song';
        li.setAttribute('draggable', 'true');
        li.dataset.song = songData.song_name;
        li.dataset.songId = songData.song_id;
        li.dataset.rankGroup = currentRankGroupKey; // This should reflect the group it's currently displayed in
        li.dataset.rankPosition = index; // Store 0-based index for display ordering

        const positionIndicator = document.createElement('span');
        positionIndicator.className = 'position-indicator';
        positionIndicator.textContent = index + 1; // 1-based index

        li.appendChild(positionIndicator);
        li.appendChild(document.createTextNode(songData.song_name));

        const scorePreview = document.createElement('span');
        scorePreview.className = 'score-preview';
        scorePreview.textContent = calculateScore(index, totalSongsInGroup, parseFloat(currentRankGroupKey));
        li.appendChild(scorePreview);

        return li;
    }

    function calculateScore(position, totalSongs, rankGroup) {
        if (totalSongs === 0) return `(N/A)`;
        if (totalSongs === 1) return `(${rankGroup.toFixed(2)})`;

        const range = 0.49;
        const effectiveTotalSongs = Math.max(1, totalSongs);
        const step = range / effectiveTotalSongs;
        const baseGroupScore = rankGroup;
        const score = baseGroupScore + (step * position);

        return `(${score.toFixed(2)})`;
    }

    // Update checkmarks and drag-ability for songs in the left panel
    function updateSongCheckmarks() {
        document.querySelectorAll('.song-item').forEach(item => {
            const songId = item.dataset.songId;
            if (isSongRankedGlobally(songId)) {
                item.classList.add('ranked');
                item.setAttribute('draggable', 'false');
                const prelimInput = item.querySelector('.prelim-rank-input');
                if (prelimInput) {
                    prelimInput.disabled = true;
                    // If song is now truly ranked, clear any prelim input
                    // (optional, but good for UX if you want to enforce this)
                    // prelimInput.value = '';
                }
            } else {
                item.classList.remove('ranked');
                item.setAttribute('draggable', 'true');
                const prelimInput = item.querySelector('.prelim-rank-input');
                if (prelimInput) {
                    prelimInput.disabled = false;
                }
            }
        });
    }

    // --- Drag and drop functionality ---
    document.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('song-item') || e.target.classList.contains('ranked-song')) {
            draggingSong = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.setData("text/plain", e.target.dataset.songId); // Pass song ID
            e.dataTransfer.effectAllowed = "move"; // Indicate move operation

            // If dragging from a ranked group, remember its original group for removal later
            if (e.target.classList.contains('ranked-song')) {
                e.dataTransfer.setData("text/original-rank-group", e.target.dataset.rankGroup);
                e.dataTransfer.setData("text/original-rank-position", e.target.dataset.rankPosition);
            } else { // Dragging from the left song list (potentially with a prelim rank)
                 const prelimInput = e.target.querySelector('.prelim-rank-input');
                 if (prelimInput) {
                     e.dataTransfer.setData("text/prelim-rank", prelimInput.value || "");
                 }
            }
        } else {
            e.preventDefault(); // Prevent dragging non-song elements
        }
    });

    document.addEventListener('dragend', function(e) {
        if (e.target.classList.contains('song-item') || e.target.classList.contains('ranked-song')) {
            e.target.classList.remove('dragging');
            draggingSong = null;

            document.getElementById('activeRankGroupDisplay').classList.remove('drag-over');
            document.querySelectorAll('.ranked-song.drag-over').forEach(el => el.classList.remove('drag-over'));

            // Re-render the display for the current group to reflect final state
            if (currentRankGroup) {
                loadRankedSongsIntoDisplay(currentRankGroup);
            }
            updateAllRankButtonIcons(); // Update icons for all rank buttons
        }
    });

    // Drop target for songs: the #activeRankGroupDisplay
    const activeRankGroupDisplay = document.getElementById('activeRankGroupDisplay');
    const rankedSongsListDisplay = document.getElementById('rankedSongsList'); // The UL inside the display

    activeRankGroupDisplay.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move"; // Visual feedback for move operation

        if (!draggingSong || !currentRankGroup) return; // Only allow drop if a group is selected

        activeRankGroupDisplay.classList.add('drag-over');

        // Highlight the specific song element to insert after/before
        const afterElement = getDragAfterElement(rankedSongsListDisplay, e.clientY);
        document.querySelectorAll('.ranked-song.drag-over').forEach(el => el.classList.remove('drag-over'));
        if (afterElement) {
            afterElement.classList.add('drag-over');
        } else if (rankedSongsListDisplay.children.length === 0) {
            // If the list is empty, highlight the entire list as a drop zone
            // This is handled by activeRankGroupDisplay.drag-over already
        }
    });

    activeRankGroupDisplay.addEventListener('dragleave', function(e) {
        // Only remove drag-over if moving completely out of the drop zone
        if (!activeRankGroupDisplay.contains(e.relatedTarget)) {
            activeRankGroupDisplay.classList.remove('drag-over');
            document.querySelectorAll('.ranked-song.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
    });

    activeRankGroupDisplay.addEventListener('drop', function(e) {
        e.preventDefault();
        activeRankGroupDisplay.classList.remove('drag-over');
        document.querySelectorAll('.ranked-song.drag-over').forEach(el => el.classList.remove('drag-over'));

        if (!draggingSong || !currentRankGroup) {
            console.warn("Drop event: No dragging song or no current rank group selected.");
            return;
        }

        const songId = e.dataTransfer.getData("text/plain");
        const songName = draggingSong.dataset.song; // Get from original dragging element
        const originalRankGroup = e.dataTransfer.getData("text/original-rank-group");
        const prelimRankFromDrag = e.dataTransfer.getData("text/prelim-rank");

        const currentGroupSongs = allRankedSongsByGroup[currentRankGroup];

        let songDataToMove = null;

        // 1. Remove song from its original location (if it was ranked)
        if (originalRankGroup) {
            const originalArray = allRankedSongsByGroup[originalRankGroup];
            const songIndexInOriginal = originalArray.findIndex(s => s.song_id === songId);
            if (songIndexInOriginal > -1) {
                [songDataToMove] = originalArray.splice(songIndexInOriginal, 1);
                console.log(`Removed song ${songName} from its original group ${originalRankGroup}`);
                // Update icon for the original group if it changed
                updateRankButtonIcon(originalRankGroup);
            }
        } else {
            // Song came from the left song list (not previously in a rank group)
            // Check if it's already ranked elsewhere (e.g. if drag-and-drop was used to bypass prelim removal)
            if (isSongRankedGlobally(songId)) {
                alert(`"${songName}" is already ranked in another group. Please unrank it first if you want to move it.`);
                return;
            }
            // Create new song data for it
            songDataToMove = {
                song_name: songName,
                song_id: songId,
                prelim_rank: prelimRankFromDrag || ""
            };
            // Also, remove it from the '?' group if it was there (as it's now explicitly ranked)
            allRankedSongsByGroup['?'] = allRankedSongsByGroup['?'].filter(s => s.song_id !== songId);
            updateRankButtonIcon('?'); // Update '?' button icon
        }

        if (!songDataToMove) {
            console.error("Song data to move is undefined.");
            return;
        }

        // 2. Determine insertion point in the target group
        const afterElement = getDragAfterElement(rankedSongsListDisplay, e.clientY);
        let insertIndex = afterElement ? Array.from(rankedSongsListDisplay.children).indexOf(afterElement) : currentGroupSongs.length;

        // If moving within the same group, and the source was before the target, adjust index
        if (originalRankGroup === currentRankGroup && afterElement && (e.dataTransfer.getData("text/original-rank-position") < insertIndex)) {
            insertIndex--;
        }

        // 3. Add to the new group
        songDataToMove.rank_group = parseFloat(currentRankGroup); // Assign the new rank group
        currentGroupSongs.splice(insertIndex, 0, songDataToMove);
        console.log(`Added song ${songName} to group ${currentRankGroup} at index ${insertIndex}`);

        // 4. Update positions for all songs in the affected group
        currentGroupSongs.forEach((s, i) => s.rank_position = i);

        // 5. Re-render the display for the current group
        loadRankedSongsIntoDisplay(currentRankGroup);
        updateSongCheckmarks(); // Update checkmarks on the left panel
        updateRankButtonIcon(currentRankGroup); // Update icon for the current group
    });


    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.ranked-song:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // --- Save/Submit functionality ---
    document.getElementById('pauseSaveBtn').addEventListener('click', function() {
        saveRankings("paused");
    });

    document.getElementById('finalRankBtn').addEventListener('click', function() {
        saveRankings("final");
    });

    function saveRankings(status) {
        const allRankedData = [];
        const prelimRankData = {};

        // Collect all ranked songs from allRankedSongsByGroup (excluding the '?' group for "final" submission)
        for (const groupKey in allRankedSongsByGroup) {
            if (groupKey !== '?') { // Only include explicitly ranked groups in the main submission data
                allRankedSongsByGroup[groupKey].forEach((song, index) => {
                    const finalScore = parseFloat(calculateScore(index, allRankedSongsByGroup[groupKey].length, parseFloat(groupKey)).slice(1,-1));
                    allRankedData.push({
                        song_id: song.song_id,
                        song_name: song.song_name,
                        rank_group: parseFloat(groupKey),
                        rank_position: index,
                        prelim_rank: song.prelim_rank, // Include prelim rank
                        calculated_score: finalScore
                    });
                });
            }
        }

        // Collect preliminary ranks from the left song list (only unranked ones)
        // Also collect songs from the '?' group as preliminary.
        document.querySelectorAll('.song-item').forEach(item => {
            const songId = item.dataset.songId;
            const prelimInput = item.querySelector('.prelim-rank-input');

            // If the song is NOT globally ranked (i.e., not in a numeric rank group)
            if (!isSongRankedGlobally(songId)) {
                if (prelimInput && prelimInput.value.trim() !== '') {
                    prelimRankData[songId] = parseFloat(prelimInput.value);
                }
            }
        });

        // Add songs from the '?' group to prelim_rank_data as well
        allRankedSongsByGroup['?'].forEach(song => {
            prelimRankData[song.song_id] = parseFloat(song.prelim_rank) || 0; // Use existing prelim_rank or default
        });


        document.getElementById('selected_rank').value = currentRankGroup || ''; // Store the last active rank group if needed
        document.getElementById('status').value = status;
        document.getElementById('all_ranked_data').value = JSON.stringify(allRankedData);
        document.getElementById('prelim_rank_data').value = JSON.stringify(prelimRankData);

        console.log("Submitting with all_ranked_data:", allRankedData);
        console.log("Submitting with prelim_rank_data:", prelimRankData);

        document.getElementById('rankingForm').submit();
    }

    // Initial render and update of button icons on page load
    document.addEventListener('DOMContentLoaded', () => {
        updateAllRankButtonIcons();

        // Automatically activate '?' group if it has songs, otherwise show generic empty state
        if (allRankedSongsByGroup['?'].length > 0) {
            const questionButton = document.getElementById('rank-btn-question');
            if (questionButton) {
                questionButton.click(); // This will activate and load '?' group songs
            }
        } else if (Object.values(allRankedSongsByGroup).flat().length > 0) {
            // If any other group has songs, activate the first one found
            for (const groupKey in allRankedSongsByGroup) {
                if (groupKey !== '?' && allRankedSongsByGroup[groupKey].length > 0) {
                    const activeButton = document.getElementById(`rank-btn-${groupKey}`);
                    if (activeButton) {
                        activeButton.click();
                        break;
                    }
                }
            }
        } else {
            // If no songs anywhere, just ensure the empty state is visible
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('emptyState').textContent = `Select a rank group above to start ranking songs.`;
            document.getElementById('rankedSongsList').style.display = 'none'; // Hide the ul
        }
    });

    </script>
</body>
</html>