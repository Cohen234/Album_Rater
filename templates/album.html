<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ album.album_name }}</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      /* Use bg_color as a valid CSS color string (e.g. "rgb(123,45,67)") */
      background-color: {{ bg_color }};
      transition: background 1.5s ease-in-out;
      display: flex;
      flex-direction: column;
    }

    .header-container {
      display: flex;
      align-items: center;
      padding: 1rem;
      background-color: rgba(255, 255, 255, 0.8);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .album-art-container {
      width: 100px;
      margin-right: 1rem;
    }

    .album-art {
      width: 100px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    .album-info h1 {
      font-size: 2rem;
      margin: 0;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .left-panel, .right-panel {
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
      box-sizing: border-box;
    }

    .left-panel {
      background-color: rgba(255,255,255,0.6);
    }

    .right-panel {
      background-color: rgba(245,245,245,0.8);
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }

    .track-item {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
    }

    .track-rank-input {
      margin-left: 1rem;
      width: 50px;
    }

    .rank-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.5rem 0 1rem;
      padding: 0.5rem;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .rank-buttons button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background-color: #333;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .rank-buttons button.rank-selected {
      background-color: #a1c4fd;
      color: #fff;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }

    /* Make the “Ranked List” area taller/bigger */
    .ranked-list {
      flex: 1;            /* Fill vertical space in right-panel */
      min-height: 300px;  /* Ensure it’s not too small */
      border: 2px dashed #aaa;
      border-radius: 8px;
      padding: 1rem;
      background-color: #fff;
      overflow-y: auto;
    }

    /* Container to hold the two submit buttons at the bottom */
    .submit-container {
      margin-top: auto;   /* Push buttons to bottom */
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding-top: 1rem;
    }

    .submit-btn {
      padding: 12px 20px;
      font-size: 1.1rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .submit-btn.pause {
      background-color: #f0a500;
    }
    .submit-btn.pause:hover {
      background-color: #d18e00;
    }

    .submit-btn.final {
      background-color: #1f7a8c;
    }
    .submit-btn.final:hover {
      background-color: #155c65;
    }

    @media (max-width: 480px) {
      .main-content {
        flex-direction: column;
      }
      .left-panel, .right-panel {
        flex: 100%;
        max-height: 50vh;
      }
      .ranked-list {
        min-height: 200px;
      }
    }
  </style>
</head>
<body>

  <div class="header-container">
    <div class="album-art-container">
      <img src="{{ album.album_cover_url }}" alt="{{ album.album_name }} cover" class="album-art">
    </div>
    <div class="album-info">
      <h1>{{ album.album_name }}</h1>
    </div>
  </div>

  <!-- One single form wrapping both panels -->
  <form action="{{ url_for('submit_rankings') }}" method="post" class="main-content">

    <!-- Left Panel: Show all tracks + preliminary‐rank inputs -->
    <div class="left-panel">
  <h2>Album Songs</h2>
  <div id="trackList">
    {% for song in album.songs %}
      <div class="track-item" draggable="true" data-song="{{ song.song_name }}">
        <span>
          {{ loop.index }}. {{ song.song_name }}
          {% if song.rank_count > 0 %}
            {% for _ in range(song.rank_count) %}
              ⭐
            {% endfor %}
          {% endif %}
          <span id="checkmark-{{ song.song_name|replace(' ', '_') }}" style="color: green; font-weight: bold; display: none;">✓</span>
        </span>
        <input class="track-rank-input"
               type="number"
               name="prelim_rank_{{ song.song_name }}"
               min="0.5"
               max="10"
               step="0.5"
               value="{{ song.prelim_rank }}">
      </div>
    {% endfor %}
  </div>
</div>

    <!-- Right Panel: Rank groups, drop area, and pause/submit buttons at bottom -->
    <div class="right-panel">
      <h2 style="margin-bottom: 0.2rem;">Select Rank Group</h2>
      <div class="rank-buttons">
        {% for rank in [1,1.5,2,2.5,3,3.5,4,4.5,5,5.5,6,6.5,7,7.5,8,8.5,9,9.5,10] %}
          <button type="button" onclick="selectRankGroup({{ rank }})">{{ rank }}</button>
        {% endfor %}
      </div>

      <h3>Rank Songs in Group</h3>
      <div class="ranked-list" id="rankedList"></div>

      <!-- Hidden fields to pass along album/artist & chosen data -->
      <input type="hidden" name="album_name"   value="{{ album.album_name }}" />
      <input type="hidden" name="artist_name"  value="{{ album.artist_name }}" />
      <input type="hidden" name="selected_rank" id="selected_rank" value="" />
      <input type="hidden" name="ranking_data" id="ranking_data" value="[]" />

      <!-- Submit Buttons -->
      <div class="submit-container">
        <button type="submit" name="status" value="paused" class="submit-btn pause">
          Pause &amp; Save
        </button>
        <button type="submit" name="status" value="final" class="submit-btn final" onclick="submitFinalRanks()">
          Submit Final
        </button>
      </div>
    </div>

  </form>

  <script>
    let draggedItem = null;
    let currentRank = null;
    let queuedRankings = {};

    function selectRankGroup(rank) {
      currentRank = rank;
      const rankedListEl = document.getElementById('rankedList');
      rankedListEl.innerHTML = "";

      // Un-highlight all rank-buttons
      document.querySelectorAll('.rank-buttons button').forEach(btn => {
        btn.classList.remove('rank-selected');
      });

      // Highlight the clicked one
      const chosenBtn = Array.from(
        document.querySelectorAll('.rank-buttons button')
      ).find(btn => btn.textContent.trim() === rank.toString());
      if (chosenBtn) {
        chosenBtn.classList.add('rank-selected');
      }

      // Load from queuedRankings if already selected
      if (queuedRankings[rank]) {
        queuedRankings[rank].forEach(songName => {
          const div = document.createElement('div');
          div.className = 'track-item';
          div.draggable = true;
          div.dataset.song = songName;
          div.textContent = songName;
          rankedListEl.appendChild(div);
        });
        updateDragEvents();
        updateRankingData();
        return;
      }

      // Fetch any already‐saved songs for that rank
      fetch(`/get_ranked_songs?album_name={{ album.album_name }}&artist_name={{ album.artist_name }}&rank=${rank}`)
        .then(resp => resp.json())
        .then(data => {
          data.songs.forEach(songName => {
            const div = document.createElement('div');
            div.className = 'track-item';
            div.draggable = true;
            div.dataset.song = songName;
            div.textContent = songName;
            rankedListEl.appendChild(div);

            // Show checkmark next to ranked song in left panel
            const checkmark = document.getElementById(`checkmark-${songName.replace(/\s/g, "_")}`);
            if (checkmark) {
              checkmark.style.display = 'inline';
            }
          });
          updateDragEvents();
          updateRankingData();
        });
    }

    function submitFinalRanks() {
      if (Object.keys(queuedRankings).length === 0) {
        alert("No rankings to submit.");
        return;
      }
      console.log("Submitting:", JSON.stringify(queuedRankings));

      fetch("/finalize_rankings", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(queuedRankings)
      }).then(resp => {
        if (resp.ok) {
          alert("All rankings submitted!");
          queuedRankings = {};
          document.getElementById('rankedList').innerHTML = "";
        } else {
          resp.text().then(msg => alert("Error: " + msg));
        }
      });
    }

    function updateDragEvents() {
      document.querySelectorAll('.track-item').forEach(item => {
        item.addEventListener('dragstart', () => {
          draggedItem = item;
        });
      });
    }

    const rankedList = document.getElementById('rankedList');
    rankedList.addEventListener('dragover', e => e.preventDefault());
    rankedList.addEventListener('drop', () => {
      if (draggedItem) {
        rankedList.appendChild(draggedItem);
        updateRankingData();
      }
    });

    function updateRankingData() {
      const items = document.querySelectorAll('#rankedList .track-item');
      const arr = Array.from(items).map(item => item.dataset.song);
      document.getElementById('ranking_data').value = JSON.stringify(arr);
      queuedRankings[String(currentRank)] = arr;

      document.querySelectorAll('.left-panel .track-item').forEach(item => {
        const song = item.dataset.song;
        const check = document.getElementById(`checkmark-${song.replace(/\s/g, "_")}`);
        if (check) {
          check.style.display = arr.includes(song) ? 'inline' : 'none';
        }
      });
    }

    // Wire initial drag events on load
    updateDragEvents();
</script>


</body>
</html>