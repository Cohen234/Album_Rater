<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ album.album_name }} — {{ album.artist_name }}</title>
  <style>
    /* make sure this is in your style block */
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: sans-serif;
      background-color: {{ bg_color }};
      transition: background 1s ease-in-out;
    }

    /* rank-selected highlight */
    .rank-selected {
      background-color: #ffcc00 !important;
      color: #000     !important;
    }

    /* basic header styling */
    .header-container {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: rgba(0,0,0,0.5);
      color: white;
    }
    .header-container img {
      height: 120px;
      border-radius: 8px;
      margin-right: 1rem;
    }
  </style>
</head>
<body>
  <!-- Header: cover + title -->
  <div class="header-container">
    <img src="{{ album.album_cover_url }}" alt="Cover for {{ album.album_name }}" />
    <h1 style="margin:0;">
      {{ album.album_name }}<br/>
      <small>{{ album.artist_name }}</small>
    </h1>
  </div>
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  /* Left Panel */
  #left-panel {
    width: 350px;
    background: rgba(0, 0, 0, 0.6);
    padding: 1rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  #album-cover {
    width: 100%;
    max-width: 250px;
    margin-bottom: 1rem;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
  }
  .song-entry {
    display: flex;
    align-items: center;
    margin-bottom: 0.6rem;
  }
  .prelim-rank-input {
    width: 60px;
    margin-right: 10px;
    font-size: 1rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: none;
  }
  /* Right Panel */
  #right-panel {
    flex: 1;
    background: rgba(0, 0, 0, 0.7);
    padding: 1rem;
    overflow-y: auto;
  }
  .rank-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 1rem;
  }
  .rank-category {
    flex: 1 1 40px;
    text-align: center;
    background: rgba(255,255,255,0.1);
    cursor: pointer;
    border-radius: 6px;
    padding: 0.4rem 0;
    user-select: none;
    font-weight: bold;
    transition: background-color 0.3s;
  }
  .rank-category.selected {
    background: #ffcc00;
    color: #000;
  }
  .drag-drop-list {
    border: 2px dashed rgba(255,255,255,0.3);
    min-height: 300px;
    border-radius: 8px;
    padding: 1rem;
    color: white;
  }
  .drag-drop-item {
    display: flex;
    justify-content: flex-end;
    padding: 0.5rem 1rem;
    margin-bottom: 0.3rem;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    cursor: grab;
  }
  .drag-drop-item span.song-order {
    width: 40px;
    text-align: right;
    margin-right: 10px;
    font-weight: bold;
  }
  .drag-drop-item span.song-name {
    flex: 1;
    text-align: left;
  }
  /* Highlighted rank button */
  .rank-selected {
    background-color: #ffcc00 !important;
    color: #000     !important;
  }
</style>
</head>
<body style="background-color: {{ bg_color }}; font-family: sans-serif; margin: 0;">

  <!-- Header -->
  <div class="header-container" style="display: flex; align-items: center; padding: 1rem; background: rgba(0,0,0,0.5);">
    <img src="{{ album.album_cover_url }}"
         alt="Cover for {{ album.album_name }}"
         style="height: 120px; border-radius: 8px; margin-right:1rem;"/>
    <h1 style="color:white; margin:0;">
      {{ album.album_name }} <small>{{ album.artist_name }}</small>
    </h1>
  </div>

  <!-- Main Form -->
  <form action="{{ url_for('submit_rankings') }}" method="post" style="display: flex; gap: 2rem; padding: 1rem;">

    <!-- Left Panel -->
    <div class="left-panel" style="flex: 1; max-width: 350px; overflow-y: auto; border-right: 1px solid #555; padding-right: 1rem;">
      <h2>Album Songs</h2>
      <div id="songList" style="display: flex; flex-direction: column; gap: 0.5rem;">
        {% for song in album.songs %}
          <div class="song-item" draggable="true"
               data-song-name="{{ song.song_name|e }}"
               data-song-id="{{ song.song_id|e }}"
               style="display: flex; align-items: center; gap: 0.5rem; background: #222; padding: 0.4rem 0.6rem; border-radius: 6px; cursor: grab; color: white;">
            <input type="number"
                   class="prelim-rank-input"
                   name="prelim_rank_{{ song.song_name|replace(' ', '_') }}"
                   min="0.5" max="10" step="0.5"
                   value="{{ song.prelim_rank or '' }}"
                   style="width: 4rem; border-radius: 4px; border: none; padding: 0.2rem 0.4rem;" />
            <span style="flex: 1;">
              {{ loop.index }}. {{ song.song_name|e }}
              {% for _ in range(song.get('rank_count', 0)) %}⭐{% endfor %}
              {% if song.already_ranked %}
                <span style="color: #0f0; font-weight: bold;">✓</span>
              {% endif %}
            </span>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel" style="flex: 1; overflow-y: auto;">
      <h2>Select Rank Group</h2>
      <div id="rankGroups" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
        {% for rank in [1,1.5,2,2.5,3,3.5,4,4.5,5,5.5,6,6.5,7,7.5,8,8.5,9,9.5,10] %}
          <button type="button"
                  class="rank-btn"
                  data-rank="{{ rank }}"
                  style="background-color: #222; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">
            {{ rank }}
          </button>
        {% endfor %}
      </div>

      <h3>Ranked Songs (Drag to reorder or add)</h3>
      <div id="rankedList" style="min-height: 300px; background: #111; border-radius: 8px; border: 2px dashed #444; padding: 0.5rem; color: white;">
        <!-- Songs in the selected rank group will appear here -->
      </div>

      <!-- Hidden Inputs -->
      <input type="hidden" name="album_name" value="{{ album.album_name }}">
      <input type="hidden" name="artist_name" value="{{ album.artist_name }}">
      <input type="hidden" name="selected_rank" id="selected_rank" value="">
      <input type="hidden" name="ranking_data" id="ranking_data" value="[]">

      <!-- Buttons -->
      <div style="margin-top: 1rem;">
        <button type="submit" name="status" value="paused" style="background: orange; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 5px; font-weight: bold;">
          Pause & Save
        </button>
        <button type="submit" name="status" value="final" onclick="prepareRankingData()" style="margin-left: 1rem; background: green; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 5px; font-weight: bold;">
          Submit Final
        </button>
      </div>
    </div>

  </form>
</body>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    let draggedItem = null;
    let currentRank = null;
    const queuedRankings = {}; // { rank: [songName, ...] }

    const rankedListEl = document.getElementById('rankedList');
    const leftPanelItems = document.querySelectorAll('.left-panel .track-item');
    const rankButtons    = document.querySelectorAll('.rank-buttons button');
    const rankingDataIn  = document.getElementById('ranking_data');

    // -- Utility: create a draggable div for a song --
    function createDraggableSongDiv(songName) {
      const div = document.createElement('div');
      div.className         = 'track-item';
      div.draggable         = true;
      div.dataset.song      = songName;
      div.innerHTML         = `<span>${songName}</span><span style="margin-left:auto;color:green;font-weight:bold;">✓</span>`;
      attachDragStart(div);
      return div;
    }

    // -- Highlight & load a rank group --
    function selectRankGroup(rank) {
      currentRank = rank;
      // clear & highlight
      rankedListEl.innerHTML = '';
      rankButtons.forEach(btn => btn.classList.remove('rank-selected'));
      const chosen = Array.from(rankButtons).find(b => b.textContent.trim() === rank.toString());
      if (chosen) chosen.classList.add('rank-selected');

      // load cached or fetch
      if (queuedRankings[rank]) {
        queuedRankings[rank].forEach(createDraggableSongDiv).forEach(el => rankedListEl.appendChild(el));
        updateRankingData();
      } else {
        fetch(`/get_ranked_songs?album_name={{ album.album_name }}&artist_name={{ album.artist_name }}&rank=${rank}`)
          .then(r => r.json())
          .then(data => {
            queuedRankings[rank] = data.songs.slice();  // initialize cache
            data.songs.forEach(name => rankedListEl.appendChild(createDraggableSongDiv(name)));
            updateRankingData();
          });
      }
    }

    // -- Attach dragstart to an element --
    function attachDragStart(el) {
      el.addEventListener('dragstart', e => {
        draggedItem = el;
        e.dataTransfer.effectAllowed = 'move';
      });
    }

    // -- Install dragstart on all left-panel items --
    leftPanelItems.forEach(item => {
      item.setAttribute('draggable', true);
      attachDragStart(item);
    });

    // -- Rank-button clicks --
    rankButtons.forEach(btn => {
      btn.addEventListener('click', () => selectRankGroup(btn.textContent.trim()));
    });

    // -- Dragover & drop on ranked list (insertion) --
    rankedListEl.addEventListener('dragover', e => {
      e.preventDefault();
      if (!draggedItem) return;
      const afterEl = getDragAfterElement(rankedListEl, e.clientY);
      if (afterEl == null) rankedListEl.appendChild(draggedItem);
      else rankedListEl.insertBefore(draggedItem, afterEl);
    });
    rankedListEl.addEventListener('drop', e => {
      e.preventDefault();
      updateRankingData();
      draggedItem = null;
    });

    // -- Helper: find element to insert before --
    function getDragAfterElement(container, y) {
      const draggable = [...container.querySelectorAll('.track-item')].filter(el => el !== draggedItem);
      return draggable.reduce((closest, child) => {
        const box    = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        }
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element || null;
    }

    // -- Update queuedRankings + hidden input + checkmarks --
    function updateRankingData() {
      if (currentRank === null) return;
      const songs = [...rankedListEl.children].map(el => el.dataset.song);
      queuedRankings[currentRank] = songs;
      rankingDataIn.value = JSON.stringify(queuedRankings);

      // toggle checkmarks on left-panel
      const allRanked = new Set(Object.values(queuedRankings).flat());
      leftPanelItems.forEach(item => {
        const name  = item.dataset.song;
        let checkEl = item.querySelector('.checkmark');
        if (!checkEl) {
          checkEl = document.createElement('span');
          checkEl.className = 'checkmark';
          checkEl.textContent = '✓';
          checkEl.style = 'margin-left:auto;color:green;font-weight:bold;display:none;';
          item.appendChild(checkEl);
        }
        checkEl.style.display = allRanked.has(name) ? 'inline' : 'none';
      });
    }

    // -- Submission override for final button (if you need it) --
    window.submitFinalRanks = function() {
      if (Object.keys(queuedRankings).length === 0) {
        alert('No rankings to submit.');
        return false;
      }
      // you can either let the form submit normally (with hidden input)
      // or do a fetch here. If form submission, return true.
      return true;
    };

    // initialize nothing selected yet
  });
  </script>


</body>
</html>